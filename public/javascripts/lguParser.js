var dump = [];

function esc(s){
    return "'" + s.split("").map(function(c){
        if (c == "'") return "''";
        return c;
    }).join("") + "'";
}

var lguId = 1;
var regions = [
    null,
    "REGION I (ILOCOS REGION)",
    "REGION II (CAGAYAN VALLEY)",
    "REGION III (CENTRAL LUZON)",
    "REGION IV-A (CALABARZON)",
    "REGION V (BICOL REGION)",
    "REGION VI (WESTERN VISAYAS)",
    "REGION VII (CENTRAL VISAYAS)",
    "REGION VIII (EASTERN VISAYAS)",
    "REGION IX (ZAMBOANGA PENINSULA)",
    "REGION X (NORTHERN MINDANAO)",
    "REGION XI (DAVAO REGION)",
    "REGION XII (SOCCSKSARGEN)",
    "NATIONAL CAPITAL REGION (NCR)",
    "CORDILLERA ADMINISTRATIVE REGION (CAR)",
    "AUTONOMOUS REGION IN MUSLIM MINDANAO (ARMM)",
    "REGION XIII (Caraga)",
    "REGION IV-B (MIMAROPA)"
];

function traverse(list, level, parent){
    for(var i in list){
        var e = list[i];
        if(!e.name) continue;
        var id;
        if(parent){
            id = lguId++;
            dump.push({id: id, name: e.name, level: level, parent: parent});
        } else {
            id = regions.indexOf(e.name);
        }
        var children;
        switch(level){
            case 0: children = "provinces"; break;
            case 1: children = "municipalities"; break;
            case 2: children = "barangays"; break;
        }

        if(!level){
            console.log(e.name + ": " + e[children].map(function(c){ return c.name; }).join(", "))
        }

        if(children) traverse(e[children], level + 1, id);
    }
}

bi.ajax(routes.controllers.Assets.at("data/lgu-structure-1.js")).then(function (r){
    traverse(r, 0);
    bi.ajax(routes.controllers.Assets.at("data/lgu-structure-2.js")).then(function (r){
        traverse(r, 0);
        bi.ajax(routes.controllers.Assets.at("data/lgu-structure-3.js")).then(function (r){

            traverse(r, 0, null);

            dump.sort(function (lgu1, lgu2){ return lgu1.id - lgu2.id; });

            document.write("--generated by lguParser<br/>");
            document.write(
                "INSERT INTO gov_units (gov_unit_name, role_id) VALUES<br/>" +
                dump.map(function (lgu){
                    return "(" + [esc(lgu.name), 1].join(", ") + ")";
                }).join(",<br/>") +
                ";;"
            );

            var name = "lgus.csv";
            var content = dump.map(function (lgu, index){
                return [
                    index+61,
                    lgu.level,
                    lgu.level > 1 ? lgu.parent + 60 : '',
                    lgu.level > 1 ? '' : lgu.parent,
                    ''
                ].join(",");
            }).join("\n");

            saveAs(new Blob([content]), name);

        });
    });
});
